<!-- templates/invoice_detail.html -->
{% extends "layout.html" %}

{% block title %}Invoice {{ invoice.invoice_number }} - Invoicing App{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="fas fa-file-invoice me-2"></i>
                    Invoice {{ invoice.invoice_number }}
                </h2>
                <p class="text-muted mb-0">{{ invoice.customer_name }}</p>
            </div>
            <div class="btn-group">
                <a href="{{ url_for('invoices') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back
                </a>
                <a href="?print" target="_blank" class="btn btn-outline-info">
                    <i class="fas fa-print me-2"></i>Print
                </a>
                <button class="btn btn-primary" onclick="recordPayment('{{ invoice.id }}, {{ invoice.balance_due }}')">
                    <i class="fas fa-credit-card me-2"></i>Record Payment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Invoice Header -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-user me-2"></i>From</h6>
            </div>
            <div class="card-body">
                <h6>{{ request.user.company_name or 'Your Company' }}</h6>
                <p class="mb-0">{{ request.user.full_name }}</p>
                <p class="mb-0">{{ request.user.email }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-building me-2"></i>To</h6>
            </div>
            <div class="card-body">
                <h6>{{ invoice.customer_name }}</h6>
                {% if invoice.customer_email %}
                <p class="mb-0">{{ invoice.customer_email }}</p>
                {% endif %}
                {% if invoice.customer_phone %}
                <p class="mb-0">{{ invoice.customer_phone }}</p>
                {% endif %}
                {% if invoice.customer_address %}
                <p class="mb-0">{{ invoice.customer_address }}</p>
                {% endif %}
                {% if invoice.customer_city %}
                <p class="mb-0">{{ invoice.customer_city }}{% if invoice.customer_country %}, {{ invoice.customer_country }}{% endif %}</p>
                {% endif %}
                {% if invoice.customer_tax_id %}
                <p class="mb-0"><small>Tax ID: {{ invoice.customer_tax_id }}</small></p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Invoice Details -->
<div class="card mb-4">
    <div class="card-header">
        <div class="row">
            <div class="col-md-6">
                <h6 class="mb-0">Invoice Details</h6>
            </div>
            <div class="col-md-6 text-end">
                <span class="badge bg-{{ 
                    'success' if invoice.status == 'paid' 
                    else 'warning' if invoice.status == 'sent' 
                    else 'danger' if invoice.status == 'overdue'
                    else 'info' if invoice.status == 'viewed'
                    else 'secondary'
                }}">
                    {{ invoice.status|upper }}
                </span>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3 mb-3">
                <label class="form-label">Invoice Number</label>
                <div class="form-control-plaintext">{{ invoice.invoice_number }}</div>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Issue Date</label>
                <div class="form-control-plaintext">{{ invoice.issue_date }}</div>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Due Date</label>
                <div class="form-control-plaintext {% if invoice.status == 'overdue' %}text-danger{% endif %}">
                    {{ invoice.due_date }}
                    {% if invoice.status == 'overdue' %}
                    <span class="badge bg-danger ms-1">OVERDUE</span>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label">Currency</label>
                <div class="form-control-plaintext">{{ invoice.currency }}</div>
            </div>
        </div>
        
        {% if invoice.reference %}
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">Reference</label>
                <div class="form-control-plaintext">{{ invoice.reference }}</div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Invoice Items -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="mb-0">Items</h6>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Description</th>
                        <th class="text-end">Quantity</th>
                        <th class="text-end">Unit Price</th>
                        <th class="text-end">Tax Rate</th>
                        <th class="text-end">Amount</th>
                    </tr>
                </thead>
                <tbody>
                {% for item in items %}
                <tr>
                    <td>{{ item.description }}</td>
                    <td class="text-end">{{ "%.2f"|format(item.quantity|float) }}</td>
                    <td class="text-end">{{ invoice.currency }} {{ "%.2f"|format(item.unit_price|float) }}</td>
                    <td class="text-end">{{ "%.2f"|format(item.tax_rate|float) }}%</td>
                    <td class="text-end">{{ invoice.currency }} {{ "%.2f"|format(item.total_amount|float) }}</td>
                </tr>
                {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <td colspan="4" class="text-end"><strong>Subtotal:</strong></td>
                        <td class="text-end"><strong>{{ invoice.currency }} {{ "%.2f"|format(invoice.subtotal|float) }}</strong></td>
                    </tr>
                    {% if invoice.tax_amount and invoice.tax_amount|float > 0 %}
                    <tr>
                        <td colspan="4" class="text-end"><strong>Tax:</strong></td>
                        <td class="text-end"><strong>{{ invoice.currency }} {{ "%.2f"|format(invoice.tax_amount|float) }}</strong></td>
                    </tr>
                    {% endif %}
                    <tr class="table-active">
                        <td colspan="4" class="text-end"><strong>Total Amount:</strong></td>
                        <td class="text-end"><strong>{{ invoice.currency }} {{ "%.2f"|format(invoice.total_amount|float) }}</strong></td>
                    </tr>
                    <tr>
                        <td colspan="4" class="text-end"><strong>Amount Paid:</strong></td>
                        <td class="text-end"><strong>{{ invoice.currency }} {{ "%.2f"|format(invoice.amount_paid|float) }}</strong></td>
                    </tr>
                    <tr>
                        <td colspan="4" class="text-end"><strong>Balance Due:</strong></td>
                        <td class="text-end">
                            <strong class="{% if invoice.balance_due|float > 0 %}text-danger{% else %}text-success{% endif %}">
                                {{ invoice.currency }} {{ "%.2f"|format(invoice.balance_due|float) }}
                            </strong>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Payments -->
{% if payments %}
<div class="card mb-4">
    <div class="card-header">
        <h6 class="mb-0"><i class="fas fa-credit-card me-2"></i>Payments Received</h6>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Method</th>
                        <th>Reference</th>
                        <th class="text-end">Amount</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments %}
                    <tr>
                        <td>{{ payment.payment_date }}</td>
                        <td>
                            <span class="badge bg-info">
                                {{ payment.payment_method|replace('_', ' ')|title }}
                            </span>
                        </td>
                        <td>{{ payment.reference_number or '-' }}</td>
                        <td class="text-end">{{ invoice.currency }} {{ "%.2f"|format(payment.amount) }}</td>
                        <td>{{ payment.notes or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Notes & Terms -->
{% if invoice.notes or invoice.terms %}
<div class="row">
    {% if invoice.notes %}
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-sticky-note me-2"></i>Notes</h6>
            </div>
            <div class="card-body">
                {{ invoice.notes|replace('\n', '<br>')|safe }}
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if invoice.terms %}
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-file-contract me-2"></i>Terms & Conditions</h6>
            </div>
            <div class="card-body">
                {{ invoice.terms|replace('\n', '<br>')|safe }}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Record Payment Modal (Same as in invoices.html) -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <!-- Same modal content as in invoices.html -->
</div>

<script>
function recordPayment(invoiceId, balance) {
    // Same function as in invoices.html
}
</script>

{% if 'print' in request.args %}
<style>
@media print {
    .navbar, .footer, .btn, .no-print {
        display: none !important;
    }
    
    body {
        font-size: 12px;
    }
    
    .card {
        border: 1px solid #dee2e6 !important;
        box-shadow: none !important;
    }
}
</style>
<script>
window.onload = function() {
    if (window.location.search.includes('print')) {
        window.print();
    }
};
</script>
{% endif %}
{% endblock %}